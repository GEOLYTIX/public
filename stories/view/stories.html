<!DOCTYPE html>
<html lang="en">

<head data-dir="{{dir}}">
    <title>Mapp Stories</title>

    <meta property="og:title" content="Mapp Stories">
    <meta name="twitter:title" content="Mapp Stories">
  
    <meta name="description" content="Mapp Stories by Women of Geolytix">
    <meta property="og:description" content="Mapp Stories by Women of Geolytix">
    <meta name="twitter:description" content="Mapp Stories by Women of Geolytix">
  
    <meta property="og:image" content="https://res.cloudinary.com/dvx8vwneg/image/upload/v1678454175/iwd_2023/glx_women_1200x627.png">
    <meta name="twitter:image" content="https://res.cloudinary.com/dvx8vwneg/image/upload/v1678454175/iwd_2023/glx_women_1200x627.png">
    
    <link rel="icon" type="image/x-icon" href="{{dir}}/icons/favicon.ico" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@main/dist/en/v7.0.0/legacy/ol.js"
    defer></script>
    <!-- Load XYZ / MAPP stylesheet and library. -->
    <link rel="stylesheet" href="{{dir}}/css/mapp.css" />
    <link rel="stylesheet" href="{{dir}}/css/ui.css" />
    <script type="module" src="{{dir}}/js/lib/mapp.js" defer></script>
    <script type="module" src="{{dir}}/js/lib/ui.js" defer></script>


    <style>

        @import url('https://fonts.googleapis.com/css2?family=Amatic+SC&display=swap');

        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300&display=swap');

        html {
            scroll-behavior: smooth;
        }

        body {
            background-color: #F8F7F9;
        }


        h1, h3, .header {
            font-family: 'Amatic SC', cursive;
        }

        h1 {
            font-size: 1.5em;
        }

        h3 {
            font-size: 1.2em;
        }

        p, a {
            font-family: 'Cormorant Garamond', serif;

        }

        a {
            color: #e91e63;
        }

        .viewport {
            height: 100vh;
        }

        #map {
            height: 100vh;
            position: fixed;
            top: 0;
            right: 0;
        }

        .dark {
            background-color: #30343F;
            color: #F8F7F9;
        }

        .lite {
            color: #30343F;
            background-color: #F8F7F9;
        }

        .header {
            display: block;
            font-size: 1.5em;
            padding: 1em;
        }

        .stories {
            overflow-y: scroll;
            position: relative;
            top: 0;
            left: 0;
        }

        .half {
            width: 50vw;
        } 

        .stories div.container {
            min-height: 100vh;
            padding: 1em;
            font-size: 1.5em;
        }

        .team-links {
            min-height: unset;
            display: grid;
            grid-gap: 1em;
            grid-template-columns: repeat(5, auto);
            align-items: center;
            margin-top: 1em;
            margin-bottom: 2em;
        }

        .team-links a {
            font-family: 'Amatic SC', cursive;
        }

        li a {
            font-size: 1.1em;
            font-family: 'Amatic SC', cursive;
        }

        .stories div.team {
            font-size: 1em;
            min-height: unset;
            padding: 0;
            margin: auto;
            cursor: pointer;
        }


        .stories .lite img {
            -webkit-filter: drop-shadow(2px 2px 5px #444);
            filter: drop-shadow(2px 2px 5px #444);
        }

        .stories .dark img {
            -webkit-filter: drop-shadow(1px 1px 2px #777)
            filter: drop-shadow(1px 1px 2px #777)
        }

        .align_c {
            text-align:  center;
        }

        .align_l {
            text-align: left;
        }

        .align_r {
            text-align: right;
        }

        #_Attribution {
            font-size: 10px;
            width: 50vw;
            background: #F8F7F9AA;
            position: fixed;
            bottom: 0;
            right: 0;
            z-index: 1001;
            display: flex;
            flex-direction: row;
            align-items: stretch;
            height: 2em;
        }

        #_Attribution * {
            margin: 2px;
        }

        #_Attribution div:nth-child(1) {
            position: absolute;
            right: 0;
        }

        .glx-logo > img {
            height: 10px;
        }

        .select-story {
            position: fixed;
            top: 30px;
            right: 20px;
            z-index: 10001;
            background-color: rgba(248, 247, 249, 0.9);
            border-radius: 50%;
            display: flex;
            padding: 5px;
        }

        .stories-list {
            padding: 5px;
            border-radius: 5px;
            display:  none;
            position: fixed;
            top: 75px;
            right: 24px;
            z-index: 10001;
            background-color: rgba(248, 247, 249, 0.9);
            min-width: 90px;
        }

        .stories-list li {
            padding: 5px;
            font-size: 12px;
            text-align: right;
        }


        @media only screen and (max-width: 768px) {
            
            #map {
                height: 30vh;
                position: fixed;
                top: 0;
                left: 0;
                box-shadow: 0 3px 3px rgb(0 0 0 / 30%);
            }

            .header {
                display: none;
            } 

            #_Attribution {
                width: 100vw;
                top: 0;
                left: 0;
                bottom: unset;
            }

            #_Attribution div:nth-child(1) {
                position: static;
            }

            #_Attribution div:nth-child(2) {
                position: absolute;
                right: 0;
            }

            .half {
                width: 100vw;
            }

            .stories {
                overflow-y: scroll;
                position: relative;
                top: 30vh;
                left: 0;
            }

            .stories div {
                min-height: 70vh;
            }

            .team-links {
                grid-template-columns: repeat(3, auto);
            }

        }
        
    </style>

</head>

<body>
    <div class="viewport">
        
        <div class="header half align_c lite">
            <img height=20 src="https://geolytix.github.io/public/mapp_v4/emblem.svg"><br>
            Mapp&nbsp;Stories
        </div>

        <div class="stories half"></div>
        
        <div id="map" class="container half">
            <div id="_Attribution">
                <div><a class="glx-logo" target="_blank" href="https://geolytix.co.uk">
                    <img src="https://geolytix.github.io/public/mapp_v4/emblem.svg">
                    <img src="https://geolytix.github.io/public/geolytix.svg">
                </a></div>
                <div class="attribution-links">
                    <a target="_blank" href="https://www.mapbox.com/about/maps">© Mapbox</a>
                    <a target="_blank" href="http://www.openstreetmap.org/copyright">© OpenStreetMap contributors</a>
                </div>
            </div>
            <div class="select-story">
                <img src="https://geolytix.github.io/public/stories/img/her_circle.svg" height=40>
            </div>
            <ul class="stories-list"></ul>
            
        </div>

    </div>

    <script>

        window.onload = async () => {
            
            mapp.host = document.head.dataset.dir;
            
            const locale = await mapp.utils.xhr(`${mapp.host}/api/workspace/locale?locale=stories`);

            const state = {};

            const mapbox = await mapp.utils.xhr(`${mapp.host}/api/workspace/layer?locale=${locale.key}&layer=mapbox`);

            const target = document.querySelector("#map");

            const mapview = mapp.Mapview({
              host: mapp.host,
              target,
              locale: locale,
              scrollWheelZoom: true
            });

            await mapview.addLayer([mapbox]);

            createStories();

            function createStoriesList() {
                if(!state.stories) return
                state.stories.map(i => document.querySelector('.stories-list').appendChild(mapp.utils.html.node`<li><a href="${`#${i}`}">${i}`));
            }

            function isInFocus(el) {
                const rect = el.getBoundingClientRect()
                return rect.top > 0 && rect.top < window.innerHeight/3; // one third to support mobile view
            }

            function setView(story) {

                if(state.layer) mapview.Map.removeLayer(state.layer);

                let pnt = new ol.Feature({
                    geometry: new ol.geom.Point([story.lng, story.lat]).transform('EPSG:4326', 'EPSG:'+ mapview.srid)
                });

                const source = new ol.source.Vector();
                source.addFeatures([pnt]);

                state.layer = new ol.layer.Vector({
                    source: source,
                    style: new ol.style.Style({
                        image: new ol.style.Icon({
                            src: story.pin || "https://geolytix.github.io/public/stories/img/her.svg",
                            scale: 3
                        })
                    })
                });

                mapview.Map.addLayer(state.layer);
                mapview.fitView(source.getExtent());
            }

            function createStories(){

                const hash = window.location.hash ? window.location.hash.substring(1) : false;
                const xhr = new XMLHttpRequest();
                //xhr.open('GET', 'http://localhost:3000/stories/public/stories.json');
                xhr.open('GET', 'https://geolytix.github.io/public/stories/data/stories.json');

                xhr.onload = e => {
                    if(!e.target) return;

                    if(!e.target.response) return;

                    let json = JSON.parse(e.target.response),
                    stories = hash && json[hash] ? json[hash] : json[Object.keys(json)[0]];

                    document.querySelector('.stories').innerHTML = '';
                    state.els = null;

                    if(!state.stories) {
                        state.stories = Object.keys(json);
                        createStoriesList();
                    }

                    stories.map((story, i) => {

                        let el = mapp.utils.html.node`<div class="${(i%2 ? 'dark' : 'lite') + ' align_c container'}" data-story='${JSON.stringify(story.location)}'>
                        ${story.profile ? mapp.utils.html.node`<img style="height: 8em;" src="${story.profile}">` : ``}
                        <h1>${story.title}</h1>
                        <h3>${story.address}</h3><br>`;

                        let p = mapp.utils.html.node`<p class="align_l">`;

                        p.innerHTML = story.description;

                        el.appendChild(p);

                        if(story.img) el.appendChild(mapp.utils.html.node`<div style="padding: 1em;"><img style="border-radius: 1.5%; width:100%;" 
                        src="${story.img}">`);

                        if(story.video) el.appendChild(mapp.utils.html.node`<div style="padding: 1em;">
                            <video controls style="border-radius: 1.5%; width:100%;">
                            <source src="${story.video}" type="${story.video_type || 'video/mp4'}">`);

                        document.querySelector('.stories').appendChild(el);
                    
                    });

                    if(!state.links) {
                        state.links = mapp.utils.html.node`<div class="lite half team-links">`;

                        Object.entries(json).map(i => {
                            let _link = mapp.utils.html.node`<div class="team">
                            <a title="${i[0]}" href="${`#${i[0]}`}">
                            <img style="height: 5em; width: 5em; object-fit: cover; border-radius: 50%;" src="${i[1][0].img || i[1][0].profile}">
                            <span style="display: block; text-align: center;">${i[0]}`;
                            state.links.appendChild(_link);
                        });
                    }

                    document.querySelector('.stories').appendChild(mapp.utils.html.node`<div class="header align_c lite">
                        <img height=20 src="https://geolytix.github.io/public/mapp_v4/emblem.svg"><br>See more of Mapp&nbsp;Stories
                        </div>`);
                    

                    document.querySelector('.stories').appendChild(state.links);

                    state.els = Array.from(document.querySelectorAll('.stories div'));
                    let el = state.els.find(el => isInFocus(el)); // initialize map view
                    let idx = state.els.indexOf(el);
                    state.prev = state.current;
                    state.current = idx < 0 ? 0 : idx;
                    let view = JSON.parse(state.els[state.current].dataset.story);
                    setView(view);

                };

                xhr.send();
            }

            document.addEventListener('scroll', () => {

                const el = state.els.find(el => isInFocus(el));
                const idx = state.els.indexOf(el);
                state.prev = state.current;
                state.current = idx;

                if(state.current === state.prev) {
                //no moving
                } else {
                    if(!el) return;
                    if(!state.els[idx]?.dataset?.story) return;
                    let view = JSON.parse(state.els[idx].dataset.story);
                    setView(view);
                };
            }, { passive: true });

            window.addEventListener('hashchange', () => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                createStories();
                let el = document.querySelector('.stories-list');
                if(el.style.display == 'block') el.style.display = 'none';

            }, false);

            document.querySelector('.select-story').addEventListener('click', e => {
                e.stopPropagation();
                let el = document.querySelector('.stories-list');
                el.style.display = el.style.display == 'block' ? 'none' : 'block';
            })


        }
        

    </script>

</body>

</html>