<!doctype html>
<html lang="{{language}}">
  <head data-dir="{{dir}}" data-login="{{login}}">
    <title>MAPP | User Administration</title>

    <link
      rel="icon"
      type="image/x-icon"
      href="{{dir}}/public/icons/favicon.ico"
    >
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
    >

    <script
      src="https://cdn.jsdelivr.net/npm/ol@v10.6.1/dist/ol.js"
      integrity="sha384-R02sHnzL8yl/uvLZvMsfgBOMBIOOHLpuLNo4dLuWQWFun1sxEWJej+SPwiGxaeGd"
      crossorigin="anonymous"
    ></script>

    <!-- Load XYZ / MAPP stylesheet and library. -->
    <!--<link rel="stylesheet" href="{{dir}}/public/css/mapp.css" /> not needed here -->
    <link rel="stylesheet" href="{{dir}}/public/css/ui.css" />

    <script type="module" src="{{dir}}/public/js/lib/mapp.js" defer></script>
    <script type="module" src="{{dir}}/public/js/lib/ui.js" defer></script>

    <script
      type="module"
      src="{{dir}}/public/js/tests/_mapp.test.js"
      defer
    ></script>

    <style>

      :root {
        --color-notification: #FEFCE8;
        --color-notification-contrast: #FDF08A;
        --color-notification-hover: #FDE048;
        --color-notification-font: #854D0F;
        --box-shadow: rgba(0, 0, 0, 0.04) 0px 3px 5px;
        --border-radius: 10px;
        --padding: 10px;

        --color-approved: #43a047;
        --color-verified: #9c27b0;
        --color-re-verify: #b71c1c;
        --color-blocked: #546e7a;
        --color-admin: #0d47a1;
        --color-api: #4527a0;
        --color-new: #e64a19;
      }

      body {
        width: 100%;
        height: 100%;
        position: absolute;

        &::-webkit-scrollbar {
          display: none;
        }
      }

      .actions {
          margin-top: 2em; 
          display: inline-flex; 
          flex-direction: row;
          flex-wrap: wrap;
          gap: 0.2em;
      }

      .details {
          margin-top: 2em;
          display: grid; 
          grid-gap: 0;

          div {
            background-color: var(--color-base-secondary);
            padding: var(--padding);
            border-bottom: 1px solid var(--color-border);
          }
      }

      /* user details dialog layout */
      dialog.user-details {
        padding: 1em;
        width: 100%;
        height: 100%;

        .details {
          grid-template-columns: 1fr 2fr;
        }

      }

      /* user approval dialog layout */
      dialog.user-approval {
        padding: 1em;
        width: 90%;
        height: 90%;

        .details {
          grid-template-columns: repeat(2, 1fr);
        }

      }

      /* User details administrative action button */
      button.admin {
        border-radius: var(--border-radius);
        min-width: 8em;

        &.block {
          .material-symbols-outlined::after {
            content: 'lock';
          }
        }

         &.unblock {
          .material-symbols-outlined::after {
            content: 'lock_open_right';
          }
        }

        &.disabled {
          pointer-events: none;
          cursor: not-allowed;
          opacity: 0.5;
        }

        * {
          pointer-events: none;
        }

        .label {
          text-overflow: ellipsis;
          font-weight: bold;
        }
      }

      /* status info dot */
      .dot {
        border-radius: 12px;
        padding: 2px 8px;
        font-weight: bold;
        color: var(--color-font-contrast);
        font-size: 0.9em;

        &.yes {
          background-color: var(--color-approved);
        }

        &.no {
          background-color: var(--color-blocked);
        }
      }

      /* reusable class for information */
      .notification {
        margin: 1em 0;
        padding: 1em;
        display: grid;
        grid-template-columns: 1fr 150px;
        grid-gap: 10px;
        background-color: var(--color-notification);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);

        span {
          margin: auto 0;
        }

        button {
          background-color: var(--color-notification-contrast);
          color: var(--color-notification-font);
          border-color: transparent;
          font-weight: bold;

          &:hover {
            background-color: var(--color-notification-hover);
          }
        }      
      }
      
      /* inside viewport */
      .viewport {
        width: 100%;
        height: 100%;
        background-color: var(--color-base);
        
        .content {
          height: 100%;
          background-color: var(--color-base-secondary);
          border-radius: var(--border-radius);
          margin: 1em;
          box-shadow: var(--box-shadow);
          padding: 1em;
          display: flex;
          flex-direction: column;

          /* begin user table */ 
        
          #users {
            height: 100%;
            width: 100%;
            overflow-y: scroll;
            overflow-x: auto;

            table {
              position: relative;
              width: 100%;
              display: table;
              overflow: scroll;
              cursor: pointer;

              thead {
                text-align: left;
                font-weight: bold;

                th {
                  position: sticky;
                  user-select: none;
                  top: 0;
                  background-color: var(--color-base);
                  box-shadow: var(--box-shadow);
                  padding: var(--padding);

                  &:first-child {
                    border-top-left-radius: var(--border-radius);
                  }

                  &:last-child {
                    border-top-right-radius: var(--border-radius);
                  }

                  /* begin table sorting */

                  &:after {
                    content: '\25be';
                    display: inline-block;
                    vertical-align: middle;
                    transform: rotate(270deg);
                  }

                  &.asc::after {
                    margin-left: 2px;
                    content: "\25be";
                    transform: rotate(180deg);
                  }

                  &.desc::after {
                    margin-left: 2px;
                    content: "\25be";
                    transform: unset;
                    vertical-align: baseline;

                  }

                  /* end table sorting */
                }
              }

              tbody {
                tr {
                  
                  &:hover {
                    background-color: var(--color-notification);
                  }
                  td {
                    padding: var(--padding);
                    border-bottom: 1px solid var(--color-border);

                  }
                }
              }
            }
          }

          /* end user table */ 

        }

      }

      /* rules for mobile */
      @media only screen and (max-width: 700px) {
        body,
        {
          margin: 0;
        }

        .desktop-only {
          display: none;
        }
      }

    </style>

    <body>

      <div class="viewport">
        <div class="content">
          <header></header>
          <div id="tools"></div>
          <div id="notification"></div>
          <div id="users"></div>
        </div>
      </div>

      <script type="module">
        console.log(`MAPP v${mapp.version}`);
        /* Set the maxWidth for mobile responsive display. */
        mapp.utils.mobile(765);

         /* expand dictionary TODO: check what's in use */
         mapp.utils.merge(mapp.dictionaries, {
          en: {
            yes: 'Yes',
            no: 'No',
            admin_view: {
              languages: {
                en: "English",
                de: "German",
                zh: "Chinese",
                zh_tw: "Chinese (Traditional)",
                pl: "Polish",
                ja: "Japanese",
                es: "Spanish",
                fr: "French",
                tr: "Turkish",
                it: "Italian",
                th: "Thai",
              },
              info: "Information",
              view: "View",
              save: "Save",
              confirm: "Confirm",
              cancel: "Cancel",
              delete: "Delete",
              new: "New",
              re_verification: "Re-verification",
              verified: "Verified",
              approved: "Approved",
              blocked: "Blocked",
              admin: "Administrator",
              api: "API Access",
              acc_details: "User Account Details",
              email: "E-mail",
              email_label: "Account e-mail address",
              lang: "Language",
              lang_label: "Account Language",
              status: "Status",
              status_description: {
                "Verified": "Check the box to verify the user",
                "Re-verification": "Checked if the user needs to re-verify after password reset",
                "Approved": "Check the box to approve the user",
                "Administrator": "Check the box to make the user an administrator",
                "API": "Check the box to allow the user API privileges",
                "Blocked": "check the box to block the user",
              },
              status_info: "Information on Status",
              roles: "Access Roles",
              roles_info: "Information on Access Roles",
              roles_no_info: "no description provided",
              roles_view: "View information on access roles",
              roles_no: "No access roles defined",
              roles_search: "Search access roles",
              approved_by: "Approved by",
              approved_label: "Last modification to this account approved by",
              expiry: "Account Expiry",
              expiry_label: "Date when user access expires",
              access_log: "Access Log",
              access_log_label: "User Access History",
              verification_token: "Verification Token",
              failed_login: "Failed Login Attempts",
              sure: "Are you sure to delete this user account?",
              undone: "This cannot be undone",
              deleted: "Account for this user has been permanently deleted.",
              delete_user: "Delete User",
              last_active: "Last active",
              logged_in_label: "Logged in as",
              back: "Back to Mapp",
              test_view: "Test View",
              logout: "Logout",
              search_accounts: "Search accounts",
              filter_status: "Filter status",
              unknown: "Unknown",
              show_blocked: "Show blocked accounts",
              top_info: "Click on a row in the table to make changes to the users permissions and roles. Click on a table header to sort.",
            },
          },
        });

      /* Get list of available roles from workspace. TODO check how to show these */
      const rolesList = await mapp.utils.xhr(
        `${document.head.dataset.dir}/api/workspace/roles?tree=true`
      );

      console.log(rolesList);

      /* List of languages key values - TODO clarify if this is needed */
      const languagesList = mapp.dictionary.admin_view.languages;

      /* TODO Get current URL params - clarify if this is needed */
      const params = new URLSearchParams(window.location.search);

      /* Create header with all needed parameters, logged in as etc. TODO review header content */
      const header = mapp.utils.html`<div>
        <img src="https://geolytix.github.io/public/geolytix_mapp.svg" height="10"/>
        <h1>User Management Dashboard</h1>
        <p>Overview of all users, their roles and account status.</p>
      </div>`;

      mapp.utils.render(document.querySelector('header'), header);

      /* create notifications placeholder section TODO clarify how this should eventually exist or work */
      const notification = mapp.utils.html`<div class="notification">
        <span>You have <b>2 pending approvals</b> that require attention</span>
        <button class="action outlined">Review pending users</button>`

      mapp.utils.render(document.getElementById('notification'), notification);


      /* create administrator actions */

      const administrator_tools = mapp.utils.html`<div class="actions">
        <button class="admin outlined"
        onclick=${() => (window.location.href = `${window.location.origin}{{dir}}`)}>
          <span class="material-symbols-outlined">arrow_back</span><br>
          <span class="label">Back to Mapp</span>
        <button>
        <button class="admin outlined"
        onclick="${() => (window.location.href = `${window.location.origin}{{dir}}?logout=true`)}">
          <span class="material-symbols-outlined">logout</span><br>
          <span class="label">Logout</span>
        <button>
      </div>`;

      mapp.utils.render(document.getElementById('tools'), administrator_tools);


      /* get users list */
      async function getUserList() {
        // Get user list from host.
        const response = await mapp.utils.xhr(
          `${document.head.dataset.dir}/api/user/list`
        );

        // Data must be an array if only 1 record returned in response.
        const data = Array.isArray(response) ? response : [response];

        data.forEach((row) => {
          row.re_verification = !row.verificationtoken;
        });

        return data;
      }

      const userList = await getUserList();

      /* create user table */
      const users = listTable({
          data: userList,
          createRow: createUserRow,
          headers: [{
            field: 'email',
            label: mapp.dictionary.admin_view.email
          },{
            field: 'roles',
            label: mapp.dictionary.admin_view.roles,
            css_class: 'desktop-only'
          }, {
            field: 'last_active',
            label: mapp.dictionary.admin_view.last_active,
            css_class: 'desktop-only'
          }, {
            field: 'status',
            label: mapp.dictionary.admin_view.status
          }]
        });

      mapp.utils.render(document.getElementById('users'), users.table);


      /* List table and its functionalities */

      function listTable(params) {

        if(!params.data) return;

        if(params.table) return params.update(params);

        params.heads = (params) => {

          if(!params.headers) return;

          const heads = params.headers.map((item, idx) => {
            const th = mapp.utils.html.node`<th class=${item.css_class || ``}>${mapp.utils.html.node`${item.label}`}`

            th.onclick = params.headerCellClick;

            return th
          });

          return heads;

        }

        params.rows = (params) => {

          params.data = Array.isArray(params.data) ? params.data : [params.data];

          const rows = params.data.map((item) => params.createRow(item));

          return rows;

        };

        params.sort = (column, asc = true) => {

          const dirModifier = asc ? 1 : -1;
          const tBody = params.table.tBodies[0];
          const rows = Array.from(tBody.querySelectorAll("tr"));

          // Sort each row
          const sortedRows = rows.sort((a, b) => {
            const td_a = a.querySelector(`td:nth-child(${column + 1})`);
            const td_b = b.querySelector(`td:nth-child(${column + 1})`);
            const aColText = td_a.textContent.trim().toLowerCase();
            const bColText = td_b.textContent.trim().toLowerCase();

            // check if column is a date
            if (td_a.dataset.iso) {
              return new Date(td_a.dataset.iso) > new Date(td_b.dataset.iso) ? 1 * dirModifier : -1 * dirModifier;
            }

            return aColText > bColText ? 1 * dirModifier : -1 * dirModifier;
          });

          tBody.replaceChildren();

          tBody.append(...sortedRows);

          params.table
          .querySelectorAll("th")
          .forEach((th) => th.classList.remove("asc", "desc"));

          params.table
          .querySelector(`th:nth-child(${column + 1})`)
          .classList.toggle("asc", asc);
          params.table
          .querySelector(`th:nth-child(${column + 1})`)
          .classList.toggle("desc", !asc);

        };

        params.update = (params) => {
          const tBody = params.table.tBodies[0];
          tBody.replaceChildren();
          const rows = params.rows(params);
          tBody.append(...rows);
        };

        params.headerCellClick = (e) => {
          e.stopPropagation();
          const headerIndex = Array.prototype.indexOf.call(e.target.parentElement.children, e.target);
          const currentIsAscending = e.target.classList.contains("asc");
          params.sort(headerIndex, !currentIsAscending);
        };

        params.ths = params.heads(params);

        params.trs = params.rows(params);

        params.thead = mapp.utils.html`<thead><tr>${params.ths}`

        params.tbody = mapp.utils.html`<tbody>${params.trs}`;

        params.table = mapp.utils.html.node`<table>${params.thead}${params.tbody}`;

        return params;
      }

      /* this function creates each row in the user table */
      function createUserRow(user) {

        const last_log_entry = user.access_log ? user.access_log.split("@")[0] : ``;

        user.last_active = user.access_log
            ? new Intl.DateTimeFormat('en-GB').format(new Date(last_log_entry))
            : ``;

        user.last_active_iso = user.last_active === "" ? null : last_log_entry;

        const active_roles = get_user_roles(user);

        return mapp.utils.html.node`<tr data-user=${JSON.stringify(user)} onclick=${user_details}>
          <td>${user.email}</td>
          <td class="desktop-only">${active_roles}</td>
          <td class="desktop-only">${user.last_active}</td>
          <td>${check_user_status(user)}</td>
          </tr>`

      }

      /* this function will display user roles in table and details TODO */
      function get_user_roles(user) {
        // TODO find out how this should be flattened and adjusted
        const active_roles = user.roles?.length ? user.roles.join(", ") : "";
        return active_roles;

      }

      /* this function determines user status */
      function check_user_status(user) {
        let state = { label: mapp.dictionary.admin_view.new, color: "var(--color-new)" };
        if (user.re_verification)
          state = {
            label: mapp.dictionary.admin_view.re_verification,
            color: "var(--color-re-verify)",
          };
        if (user.verified)
          state = {
            label: mapp.dictionary.admin_view.verified,
            color: "var(--color-verified)",
          };
        if (user.approved)
          state = {
            label: mapp.dictionary.admin_view.approved,
            color: "var(--color-approved)",
          };
        if (user.admin)
          state = { label: mapp.dictionary.admin_view.admin, color: "var(--color-admin)" };
        if (user.blocked)
          state = {
            label: mapp.dictionary.admin_view.blocked,
            color: "var(--color-blocked)"
          };

        return mapp.utils.html`<span class="dot" style=${'background-color: ' + state.color}>${state.label}</span>`;
      }

      /* this function creates user details layout with actions */
      function user_details(e) {

        const user = JSON.parse(e.target.closest('tr').dataset.user);

        // TODO prevent grant roles for blocked users. Should it be prevented if no roles exist?
        const grant_btn = mapp.utils.html`
            <button class="${'admin outlined grant' + (user.blocked || !Object.keys(rolesList).length ? ' disabled' : '')}">
              <span class="material-symbols-outlined">add_moderator</span><br>
              <span class="label">Grant Roles</span>
            </button>`;

        // TODO prevent approval when roles exist and have not been visited?
        const approve_btn = mapp.utils.html`
            <button class="${'admin outlined approve' + (user.blocked ? ' disabled' : '')}"
            data-user=${JSON.stringify(user)}
            data-keep=true
            onclick=${userApproval}>
              <span class="material-symbols-outlined">approval</span><br>
              <span class="label">Approval</span>
            </button>`;

        const access_log_btn = mapp.utils.html`
            <button class="admin outlined access-log disabled">
              <span class="material-symbols-outlined">pace</span><br>
              <span class="label">Access Log</span>
            </button>`;

        const actions = mapp.utils.html.node`
        <div class="actions">
          <button class="admin outlined" onclick=${e => {
           dialog.close();
            }}>
            <span class="material-symbols-outlined">back_to_tab</span><br>
            <span class="label">Back to List</span>
          </button>
           ${grant_btn}
           ${approve_btn}
           ${access_log_btn}
        </div>`;

        const bottom_actions = mapp.utils.html`
          <div class="actions">
          <button class=${'admin outlined ' + (user.blocked ? 'unblock' : 'block')} data-keep=true data-user=${JSON.stringify(user)}
          onclick=${blockAccount}>
            <span class="material-symbols-outlined"></span><br>
            <span class="label">${user.blocked ? 'Unblock Account' : 'Block Account'}</span>
          </button>
          <button class="admin outlined" data-email=${user.email} onclick=${deleteAccount}>
            <span class="material-symbols-outlined">account_circle_off</span><br>
            <span class="label">Delete Account</span>
          </button></div>`;

          const user_details_layout = mapp.utils.html`<div class="details">${user_details_content(user)}`;


        const content = [
          actions,
          user_details_layout,
          bottom_actions
        ];

        const dialog = mapp.ui.elements.dialog({
          target: document.body,
          header: mapp.utils.html.node`<h1>${mapp.dictionary.admin_view.acc_details}`,
          class: 'user-details box-shadow',
          closeBtn: true,
          onClose: async (e) => {
            // if users list needs update request data and recreate rows
            if(!dialog.node.dataset.update) return;
            users.data = await getUserList();
            users.update(users);
          },
          content,
        });
      }

      /* this function deletes user account after confirmation and returns to main view */
      async function deleteAccount(e) {

        const email = e.target.dataset.email;

        const text = `${email}\n${mapp.dictionary.admin_view.sure}\n${mapp.dictionary.admin_view.undone}`;

        const confirm = await mapp.ui.elements.confirm({ 
          text
        });

        if (confirm) {
            const response = await mapp.utils.xhr(`${document.head.dataset.dir}/api/user/delete?email=${email}`);
            if (response?.err) return console.error(response.err);
            // close details and refresh users table
            updateUsersList(e);
        }

      }

      /* this function blocks user account after confirmation */
      async function blockAccount(e) {

        const user = JSON.parse(e.target.dataset.user);

        //const user_email = e.target.dataset.user;
        const text = `${user.email}\n${user.blocked ? 
          'Are you sure to unblock this user account?' : 'Are you sure to block this user account?'}`;

        const confirm = await mapp.ui.elements.confirm({ 
          text
        });

        if (confirm) {

          user.blocked = !user.blocked;

          await fetch(`${document.head.dataset.dir}/api/user/update`, {
            method: "POST",
            body: JSON.stringify({email: user.email, blocked: user.blocked}),
            headers: {
              "Content-type": "application/json",
            },
          });
          // refresh user content while keeping the user details window on
          mapp.utils.render(document.querySelector('.user-details .details'), user_details_content(user));
          // update button label
          e.target.querySelector('.label').textContent = user.blocked ? 'Unblock Account' : 'Block Account';
          // update button icon
          e.target.classList.toggle('block', 'unblock');
          document.querySelector('.grant').classList.toggle('disabled');
          document.querySelector('.approve').classList.toggle('disabled');
          // update user attribute in the target
          e.target.dataset.user = JSON.stringify(user);
          updateUsersList(e);

        }

      }

      /* this function modifies user account and returns to updated user details view. Called inside userApproval */
      async function approveAccount(e) {
        if(!e.target.dataset?.user) {
          // no changes made
          return;
        }

        const user = JSON.parse(e.target.dataset.user);

        //console.log('hello approve these changes and exit to newly updated user details and then user table!');
        await fetch(`${document.head.dataset.dir}/api/user/update`, {
          method: "POST",
          body: JSON.stringify({
            email: user.email,
            approved: user.approved,
            verified: user.verified,
            admin: user.admin,
            api: user.api,
            expires_on: user.expires_on
          }),
          headers: {
            "Content-type": "application/json",
          },
        });

        // refresh user content while keeping the user details window on
        mapp.utils.render(document.querySelector('.user-details .details'), user_details_content(user));
        // update details and the list but keep details open
        updateUsersList(e);
        // close approval window
        e.target.closest('dialog.user-approval').close();

      }

      /* this function displays editable user details where changes are saved and approval process is completed */
      async function userApproval(e) {

        const user = JSON.parse(e.target.dataset.user);

        const expiry_date = mapp.utils.temporal.date(parseInt(user.expires_on));

        const expiry_date_input = mapp.utils.html.node`<input
          type="date"
          value="${expiry_date}"
          onchange=${(e) => {
            user.expires_on = mapp.utils.temporal.dateToUnixEpoch(e.target.value);
            save_btn.dataset.user = JSON.stringify(user);
          }}>`;

        const verification = mapp.ui.elements.chkbox({
          checked: user.verified,
          label: mapp.dictionary.admin_view.status_description["Verified"],
          onchange: (checked) => {
            user.verified = checked;
            save_btn.dataset.user = JSON.stringify(user);
          }
        });

        const re_verification = mapp.ui.elements.chkbox({
          checked: user.re_verification,
          disabled: true,
          label: mapp.dictionary.admin_view.status_description["Re-verification"]
        });

        const approved = mapp.ui.elements.chkbox({
          checked: user.approved,
          label: mapp.dictionary.admin_view.status_description["Approved"],
          onchange: (checked) => {
            user.approved = checked;
            save_btn.dataset.user = JSON.stringify(user);
          }
        });

        const admin = mapp.ui.elements.chkbox({
          checked: user.admin,
          label: mapp.dictionary.admin_view.status_description["Administrator"],
          onchange: (checked) => {
            user.admin = checked;
            save_btn.dataset.user = JSON.stringify(user);
          }
        });

        const api_access = mapp.ui.elements.chkbox({
          checked: user.api_access,
          label: mapp.dictionary.admin_view.status_description["API"],
          onchange: (checked) => {
            user.api_access = checked;
            save_btn.dataset.user = JSON.stringify(user);
          }
        });

        /* saves changes to user account */
        const save_btn = mapp.utils.html.node`<button class="save admin outlined" data-keep=true
        onclick=${approveAccount}>
        <span class="material-symbols-outlined">verified</span><br>
        <span class="label">Approve Changes</span>
        </button>`;

        const cancel_btn = mapp.utils.html.node`<button class="save admin outlined"
        onclick=${(e) => {
          e.target.closest('dialog.user-approval').close();
        }}>
        <span class="material-symbols-outlined">arrow_back</span><br>
        <span class="label">Exit</span>
        </button>`;

        const content = mapp.utils.html`
          <div class="notification"><b>Visit Grant Roles section in order to set user roles.</b></div>
          <div class="actions">
            ${cancel_btn}
            ${save_btn}
          </div>
          <div class="details">
          <div><b>${mapp.dictionary.admin_view.email_label}</b></div>
          <div><b>${user.email}</b></div>
          <div>
            <span class="dot" style="background-color: var(--color-verified)">${mapp.dictionary.admin_view.verified}</span>
          </div>
          <div>${verification}</div>
          <div>
            <span class="dot" style="background-color: var(--color-re-verify">${mapp.dictionary.admin_view.re_verification}</span>
          </div>
          <div>${re_verification}</div>
          <div>
            <span class="dot" style="background-color: var(--color-approved)">${mapp.dictionary.admin_view.approved}</span>
          </div>
          <div>${approved}</div>
          <div>
            <span class="dot" style="background-color: var(--color-admin)">${mapp.dictionary.admin_view.admin}</span>
          </div>
          <div>${admin}</div>
          <div>
            <span class="dot" style="background-color: var(--color-api)">${mapp.dictionary.admin_view.api}</span>
          </div>
          <div>${api_access}</div>
          <div>
            <span class="dot" style="background-color: var(--color-blocked)">${mapp.dictionary.admin_view.expiry_label}<span>
          </div>
          <div>${expiry_date_input}</div>
          </div>
        `;

        const dialog = mapp.ui.elements.dialog({
          header: mapp.utils.html.node`<h1>Approval`,
          class: 'user-approval box-shadow',
          closeBtn: true,
          content,
        });

      }

      /* this function sets update flag on user details window in order to update list of users with edited values after exit to main view */
      function updateUsersList(e) {

        const userDetails = document.querySelector('dialog.user-details');
        // set attribute for update
        userDetails.dataset.update = true;
        // if button has keep option keep the user details dialog open
        if(e.target.dataset.keep) return;
        userDetails.close();

      }

      // user prop content for read only TODO will require to be updated as well 
      function user_details_content(user) {

        const expiryDate = user.expires_on ? 
        new Intl.DateTimeFormat('en-GB').format(new Date(user.expires_on * 1000)) : `-`;

        const expiryDateEntry = user.expires_on === undefined ? 
        `` : mapp.utils.html`<div>${mapp.dictionary.admin_view.expiry_label}</div><div>${expiryDate}</div>`;

        const api_access = user.api ? mapp.utils.html`<span class="dot yes">${mapp.dictionary.yes}` : mapp.utils.html`<span class="dot no">${mapp.dictionary.no}`;

        const approved_by = user.approved_by ? 
        `${user.approved_by.split('|')[0]}` : `-`;

        const approved_on = user.approved_by?.split('|')[1] ? 
        new Intl.DateTimeFormat('en-GB').format(new Date(user.approved_by?.split('|')[1])) : `-`;

        const elements = mapp.utils.html`
          <div>${mapp.dictionary.admin_view.email_label}</div>
          <div><b>${user.email}</b>
          </div>
          <div>${mapp.dictionary.admin_view.lang_label}</div>
          <div>${mapp.dictionary.admin_view.languages[user.language]}</div>
          <div>Account Status</div>
          <div>${check_user_status(user)}</div>
          <div>User Access Roles</div>
          <div>${get_user_roles(user)}</div>
          <div>API Access</div>
          <div>${api_access}</div>
          ${expiryDateEntry}
          <div>Last active</div>
          <div>${user.last_active}</div>
          <div>${mapp.dictionary.admin_view.approved_label}</div>
          <div>${approved_by}</div>
          <div>Last modification approved on</div>
          <div>${approved_on}</div>
          <div>${mapp.dictionary.admin_view.verification_token}</div>
          <div>${user.verificationtoken}</div>
          <div>${mapp.dictionary.admin_view.failed_login}</div>
          <div>${user.failedattempts}</div>
        `;

        return elements;
      }


      </script>

    </body>

  </head>